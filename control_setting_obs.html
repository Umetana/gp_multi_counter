<!-- GPマルチカウンター OBS専用設定パネル v0.3.4 -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GP SETTINGS - OBS Edition v0.3.4</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg-dark: #16181d;
            --bg-main: #2b2e3b;
            --bg-panel: #383c4a;
            --text-main: #efefef;
            --text-sub: #aaa;
            --border: #444;
            --accent: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
        }

        body {
            font-family: sans-serif;
            font-size: 12px;
            margin: 0;
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header-tabs {
            background: var(--bg-dark);
            padding: 4px;
            display: flex;
            gap: 4px;
            overflow-x: auto;
            border-bottom: 2px solid var(--primary);
            flex-shrink: 0;
        }
        .header-tabs::-webkit-scrollbar { height: 3px; }
        .header-tabs::-webkit-scrollbar-thumb { background: var(--primary); }

        .id-tab {
            padding: 5px 12px;
            background: #444;
            border: none;
            border-radius: 3px;
            color: #ccc;
            white-space: nowrap;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }
        .id-tab.active { background: var(--primary); color: white; }
        .add-btn { background: var(--accent); color: white; }

        .settings-nav {
            display: flex;
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
            overflow-x: auto;
        }
        .nav-item {
            flex: 1;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 10px;
            color: var(--text-sub);
            white-space: nowrap;
        }
        .nav-item.active {
            color: white;
            border-bottom-color: var(--primary);
            background: rgba(255,255,255,0.05);
        }

        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }

        .section-box {
            background: var(--bg-panel);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        .row label {
            width: 70px;
            font-size: 11px;
            color: var(--text-sub);
            flex-shrink: 0;
        }

        input[type="text"], select, input[type="number"], textarea {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: white;
            padding: 6px;
            border-radius: 3px;
            flex: 1;
            min-width: 0;
            font-size: 11px;
        }
        textarea { height: 80px; font-family: monospace; font-size: 10px; resize: none; }

        .num-ctrl {
            display: flex;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        .num-ctrl button {
            background: transparent;
            border: none;
            color: var(--primary);
            padding: 4px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .num-ctrl input { border: none; width: 50px; text-align: center; }

        .checkbox-row {
            margin: 5px 0 5px 78px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 11px;
        }

        .color-ui { display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; }
        input[type="color"] { width: 24px; height: 26px; border: none; background: none; cursor: pointer; padding: 0; flex-shrink: 0; }
        .alpha-input { width: 40px !important; flex: none !important; text-align: center; }
        .code-input { flex: 1; min-width: 60px; font-family: monospace; }

        #confirm-zone {
            display: none;
            background: #502d2d;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
            border: 1px solid var(--danger);
        }
        .conf-btns { display: flex; gap: 8px; margin-top: 8px; }

        .footer {
            padding: 8px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            font-size: 11px;
        }
        .btn-apply { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; flex: 0.3; font-size: 10px; }

        #toast {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 12px 24px;
            border-radius: 4px;
            display: none;
            z-index: 1000;
            border: 1px solid var(--primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-size: 11px;
        }
    </style>
</head>
<body>

<div id="tab-list" class="header-tabs"></div>

<div class="settings-nav">
    <div class="nav-item active" id="nav-basic" onclick="switchSection('basic')">数値・基本</div>
    <div class="nav-item" id="nav-text" onclick="switchSection('text')">文字・寸</div>
    <div class="nav-item" id="nav-style" onclick="switchSection('style')">色・不透明</div>
    <div class="nav-item" id="nav-io" onclick="switchSection('io')">入出力</div>
</div>

<div class="scroll-content">
    <div id="confirm-zone">
        <div id="confirm-msg" style="font-size: 11px; font-weight: bold;"></div>
        <div class="conf-btns">
            <button class="btn btn-danger" id="conf-yes">はい</button>
            <button class="btn" onclick="hideConfirm()" style="background:#555; color:white;">キャンセル</button>
        </div>
    </div>
    <div id="main-editor"></div>
</div>

<div class="footer">
    <button onclick="saveAndSync()" class="btn btn-apply">設定を保存・適用</button>
</div>
<div class="footer">
    <button class="btn btn-danger" onclick="showConfirm('reset')">リセット</button>
    <button class="btn btn-danger" onclick="showConfirm('delete')">タブ削除</button>
</div>

<div id="toast"></div>

<script>
    const channel = new BroadcastChannel('obs_counter_sync');
    let allData = [];
    let activeId = 'counter1';
    let currentSection = 'basic';

    function load() {
        const saved = localStorage.getItem("allCountersSettings");
        if (saved) {
            allData = JSON.parse(saved);
            if (!allData.find(c => c.id === activeId)) activeId = allData[0]?.id || 'counter1';
        } else {
            allData = [
                { id: 'counter1', label: 'カウンター1', count: 0, unit: '回', goalCount: 100, showGoal: false, bgColor: 'rgba(0,0,0,0.5)', borderColor: '#ffffff', textColor: '#ffffff', labelSize: '20px', countSize: '48px', isBold: true, isShadow: true, fontFamily: 'sans-serif' }
            ];
        }
        render();
    }

    function render() {
        renderIDTabs();
        renderEditor();
    }

    function renderIDTabs() {
        const container = document.getElementById('tab-list');
        let html = allData.map(c => `
            <button class="id-tab ${c.id === activeId ? 'active' : ''}" onclick="switchID('${c.id}')">
                ${c.label || c.id}
            </button>
        `).join('');
        html += `<button class="id-tab add-btn" onclick="addCounter()">＋追加</button>`;
        container.innerHTML = html;
    }

    window.addCounter = () => {
        const nextNum = allData.length > 0 ? Math.max(...allData.map(c => parseInt(c.id.replace('counter','')) || 0)) + 1 : 1;
        const newId = 'counter' + nextNum;
        const base = allData[0] || { label: '新規', count: 0, unit: '回', goalCount: 100, showGoal: false, bgColor: 'rgba(0,0,0,0.5)', borderColor: '#ffffff', textColor: '#ffffff', labelSize: '20px', countSize: '48px', isBold: true, isShadow: true, fontFamily: 'sans-serif' };
        allData.push({...base, id: newId, label: '新規' + nextNum, count: 0});
        activeId = newId;
        saveAndSync(true);
    };

    function switchID(id) { activeId = id; hideConfirm(); render(); }

    function switchSection(sec) {
        currentSection = sec;
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.toggle('active', el.id === 'nav-' + sec);
        });
        renderEditor();
    }

    function renderEditor() {
        const container = document.getElementById('main-editor');
        const c = allData.find(item => item.id === activeId);
        if (!c && currentSection !== 'io') return container.innerHTML = "選択エラー";

        let html = '<div class="section-box">';
        if (currentSection === 'basic') {
            html += `
                <div class="row"><label>表示ラベル</label><input type="text" id="f-label" value="${c.label}"></div>
                <div class="row"><label>現在の数値</label>
                    <div class="num-ctrl">
                        <button onclick="step('f-count',-1)">-</button>
                        <input type="number" id="f-count" value="${c.count}">
                        <button onclick="step('f-count',1)">+</button>
                    </div>
                </div>
                <div class="row"><label>単位</label><input type="text" id="f-unit" value="${c.unit}"></div>
                <div class="row"><label>目標数値</label>
                    <div class="num-ctrl">
                        <button onclick="step('f-goal',-1)">-</button>
                        <input type="number" id="f-goal" value="${c.goalCount}">
                        <button onclick="step('f-goal',1)">+</button>
                    </div>
                </div>
                <div class="checkbox-row">
                    <label><input type="checkbox" id="f-showGoal" ${c.showGoal ? 'checked' : ''}> 目標を表示する</label>
                </div>
            `;
        } else if (currentSection === 'text') {
            html += `
                <div class="row"><label>書体(択)</label>
                    <select id="f-font-sel" onchange="document.getElementById('f-font-raw').value=this.value">
                        <option value="">-- 選択 --</option>
                        <option value="sans-serif">ゴシック</option>
                        <option value="serif">明朝</option>
                        <option value="'Meiryo', sans-serif">メイリオ</option>
                        <option value="'Yu Gothic', sans-serif">游ゴシック</option>
                    </select>
                </div>
                <div class="row"><label>書体(手動)</label><input type="text" id="f-font-raw" value="${c.fontFamily}"></div>
                <div class="row"><label>ラベル(px)</label><input type="number" id="f-lSize" value="${parseInt(c.labelSize)}"></div>
                <div class="row"><label>数値(px)</label><input type="number" id="f-cSize" value="${parseInt(c.countSize)}"></div>
                <div class="checkbox-row">
                    <label><input type="checkbox" id="f-bold" ${c.isBold ? 'checked' : ''}> 太字</label>
                    <label><input type="checkbox" id="f-shadow" ${c.isShadow ? 'checked' : ''}> 文字影</label>
                </div>
            `;
        } else if (currentSection === 'style') {
            html += `
                <div class="row"><label>文字の色</label>
                    <div class="color-ui">
                        <input type="color" oninput="document.getElementById('f-textColor').value=this.value" value="${toHex(c.textColor)}">
                        <input type="text" id="f-textColor" value="${c.textColor}" class="code-input">
                    </div>
                </div>
                <div class="row"><label>背景の色</label>
                    <div class="color-ui">
                        <input type="color" oninput="handleColorPicker('f-bgColor-hex', this.value, 'f-bgColor-alpha')" id="f-bgColor-p" value="${toHex(c.bgColor)}">
                        <input type="text" id="f-bgColor-hex" value="${c.bgColor}" class="code-input" oninput="handleCodeInput(this, 'f-bgColor-alpha', 'f-bgColor-p')">
                        <input type="number" id="f-bgColor-alpha" class="alpha-input" step="0.1" min="0" max="1" value="${getAlpha(c.bgColor)}" oninput="handleAlphaInput(this, 'f-bgColor-hex', 'f-bgColor-p')">
                    </div>
                </div>
                <div class="row"><label>枠線の色</label>
                    <div class="color-ui">
                        <input type="color" oninput="handleColorPicker('f-bdColor-hex', this.value, 'f-bdColor-alpha')" id="f-bdColor-p" value="${toHex(c.borderColor)}">
                        <input type="text" id="f-bdColor-hex" value="${c.borderColor}" class="code-input" oninput="handleCodeInput(this, 'f-bdColor-alpha', 'f-bdColor-p')">
                        <input type="number" id="f-bdColor-alpha" class="alpha-input" step="0.1" min="0" max="1" value="${getAlpha(c.borderColor)}" oninput="handleAlphaInput(this, 'f-bdColor-hex', 'f-bdColor-p')">
                    </div>
                </div>
                <div style="font-size:9px; color:var(--text-sub); margin-top:5px; line-height:1.4;">
                    ・不透明度を動かすとrgba形式に変換されます。<br>
                    ・コード欄に直接rgba(..., 0.5)等と入力しても、不透明度欄が連動します。
                </div>
            `;
        } else if (currentSection === 'io') {
            html += `
                <div style="font-size:11px; margin-bottom:8px;">設定データ (JSON)</div>
                <textarea id="io-area" placeholder="ここにJSONデータを貼り付けるか、書出しボタンを押してください"></textarea>
                <div class="conf-btns" style="margin-top:10px;">
                    <button class="btn" onclick="exportData()" style="background:var(--primary); color:white;">設定を書出す</button>
                    <button class="btn" onclick="importData()" style="background:var(--warning); color:white;">設定を読込む</button>
                </div>
            `;
        }
        html += '</div>';
        container.innerHTML = html;
    }

    // 1. コード欄に直接入力した場合の処理
    window.handleCodeInput = (inputEl, alphaId, pickerId) => {
        const val = inputEl.value;
        const alphaEl = document.getElementById(alphaId);
        const pickerEl = document.getElementById(pickerId);

        // HEXならピッカーに同期
        if (val.startsWith('#')) {
            pickerEl.value = toHex(val);
        } 
        // RGBAなら中の不透明度を抜き出してスライダーに同期
        else if (val.includes('rgba')) {
            const extractedAlpha = getAlpha(val);
            alphaEl.value = extractedAlpha;
            pickerEl.value = toHex(val);
        }
    };

    // 2. 不透明度スライダー（数値入力）を動かした場合の処理
    window.handleAlphaInput = (alphaEl, hexInputId, pickerId) => {
        const hexInput = document.getElementById(hexInputId);
        const alpha = alphaEl.value;
        // 現在の色成分を維持したまま、新しい不透明度でrgbaを生成してコード欄を更新
        hexInput.value = applyAlpha(hexInput.value, alpha);
    };

    // 3. カラーピッカーで色を選んだ際の処理
    window.handleColorPicker = (targetHexId, colorValue, alphaId) => {
        const alpha = document.getElementById(alphaId).value;
        document.getElementById(targetHexId).value = applyAlpha(colorValue, alpha);
    };

    window.saveAndSync = (silent = false) => {
        const item = allData.find(i => i.id === activeId);
        if (item) {
            if(document.getElementById('f-label')) {
                item.label = document.getElementById('f-label').value;
                item.count = parseInt(document.getElementById('f-count').value);
                item.unit = document.getElementById('f-unit').value;
                item.goalCount = parseInt(document.getElementById('f-goal').value);
                item.showGoal = document.getElementById('f-showGoal').checked;
            }
            if(document.getElementById('f-font-raw')) {
                item.fontFamily = document.getElementById('f-font-raw').value;
                item.labelSize = document.getElementById('f-lSize').value + "px";
                item.countSize = document.getElementById('f-cSize').value + "px";
                item.isBold = document.getElementById('f-bold').checked;
                item.isShadow = document.getElementById('f-shadow').checked;
            }
            if(document.getElementById('f-textColor')) {
                item.textColor = document.getElementById('f-textColor').value;
                // ここではコード欄に入っている文字列をそのまま保存する
                // (handleAlphaInput等で既に適切なrgba/hexになっているはず)
                item.bgColor = document.getElementById('f-bgColor-hex').value;
                item.borderColor = document.getElementById('f-bdColor-hex').value;
            }
        }

        localStorage.setItem("allCountersSettings", JSON.stringify(allData));
        channel.postMessage({ type: 'update', payload: allData });
        
        if(!silent) showToast("保存・適用しました");
        render();
    };

    window.step = (id, delta) => {
        const el = document.getElementById(id);
        el.value = Math.max(0, parseInt(el.value) + delta);
    };

    window.showConfirm = (type) => {
        const zone = document.getElementById('confirm-zone');
        const msg = document.getElementById('confirm-msg');
        const yesBtn = document.getElementById('conf-yes');
        zone.style.display = 'block';
        if(type === 'reset') {
            msg.textContent = `[${activeId}] の数値を0に戻しますか？`;
            yesBtn.onclick = () => {
                const item = allData.find(i => i.id === activeId);
                if(item) item.count = 0;
                saveAndSync(true);
                hideConfirm();
            };
        } else if(type === 'delete') {
            msg.textContent = `[${activeId}] を完全に削除しますか？`;
            yesBtn.onclick = () => {
                allData = allData.filter(i => i.id !== activeId);
                activeId = allData[0]?.id || 'counter1';
                saveAndSync(true);
                hideConfirm();
            };
        }
    };
    window.hideConfirm = () => document.getElementById('confirm-zone').style.display = 'none';

    window.exportData = () => {
        document.getElementById('io-area').value = JSON.stringify(allData, null, 2);
        showToast("データを書出しました。コピーして保存してください。");
    };

    window.importData = () => {
        try {
            const data = JSON.parse(document.getElementById('io-area').value);
            if(Array.isArray(data)) {
                allData = data;
                activeId = allData[0]?.id || 'counter1';
                saveAndSync(true);
                showToast("データを読込みました");
            }
        } catch(e) { showToast("エラー: 無効な形式です"); }
    };

    function applyAlpha(color, alpha) {
        const hex = toHex(color);
        return hexToRgba(hex, alpha);
    }

    function showToast(txt) {
        const t = document.getElementById('toast');
        t.textContent = txt;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1500);
    }

    function toHex(col) {
        if (!col) return '#ffffff';
        if (col.startsWith('#')) {
            // #fff などの短縮形を #ffffff に補完
            if (col.length === 4) return "#" + col[1] + col[1] + col[2] + col[2] + col[3] + col[3];
            return col;
        }
        const m = col.match(/\d+/g);
        if(!m) return '#ffffff';
        return "#" + m.slice(0,3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
    }

    function getAlpha(col) {
        if (!col || col.startsWith('#')) return "1.0";
        // rgba(r, g, b, a) の a 部分を抽出
        const m = col.match(/[\d.]+\s*\)$/);
        return m ? m[0].replace(')', '').trim() : "1.0";
    }

    function hexToRgba(hex, a) {
        if(!hex || !hex.startsWith('#')) return hex;
        const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${a})`;
    }

    load();
</script>
</body>
</html>