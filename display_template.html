<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>GP Skin Template</title>
    <style>
        /* 1. 表示エリアの基本スタイル（配信画面に映る部分） */
        body { 
            margin: 0; 
            background: transparent; 
            font-family: sans-serif; 
            color: #fff; 
            overflow: hidden; 
        }

        #display-area {
            padding: 20px;
            display: inline-block;
            /* ここに共通の文字影などを入れておくと便利 */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* 2. 設定エリア（OBSの「対話」でのみ見える部分） */
        .debug-settings {
            margin-top: 100px; /* 配信画面に映らないよう大きく離す */
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            color: #ccc;
            font-size: 12px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div id="display-area">
        <div id="label-node">Loading...</div>
        <div id="count-node">0</div>
    </div>

    <div class="debug-settings">
        <div>対象ID: <span id="target-id">-</span></div>
        <div style="font-size: 10px; color: #888;">
            ※ファイル名を「display_counter2.html」等に変更すると自動で切り替わります
        </div>
    </div>

<script>
(function() {
    /**
     * ID判定ロジック（仕様書 v1.1.0 準拠）
     * URLパラメータ優先、次いでファイル名から抽出
     */
    function getMyId() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('id')) return params.get('id');

        const fileName = window.location.pathname.split('/').pop();
        const match = fileName.match(/counter(\d+)/i);
        return match ? 'counter' + match[1] : 'counter1';
    }

    const MY_ID = getMyId();
    document.getElementById('target-id').textContent = MY_ID;

    const ch = new BroadcastChannel('obs_counter_sync');

    /**
     * 描画ロジック
     * @param {Object} d - 仕様書に基づいたカウンターデータ1件
     */
    function apply(d) {
        if (!d || d.id !== MY_ID) return;

        // ラベルと数値の更新
        document.getElementById('label-node').textContent = d.label || "";
        document.getElementById('count-node').textContent = d.count + (d.unit || "");

        // スタイルの適用例（仕様書の各項目を利用）
        const area = document.getElementById('display-area');
        area.style.color = d.textColor;
        area.style.fontFamily = d.fontFamily;
        
        const countNode = document.getElementById('count-node');
        countNode.style.fontSize = d.countSize;
        countNode.style.fontWeight = d.isBold ? "bold" : "normal";

        // 目標達成時の演出などの条件分岐もここで
        if (d.showGoal && d.count >= d.goalCount) {
            // 達成時の処理
        }
    }

    // --- 同期受信 ---
    ch.onmessage = (e) => {
        if (e.data?.type === 'update' && Array.isArray(e.data.payload)) {
            const me = e.data.payload.find(x => x.id === MY_ID);
            if (me) apply(me);
        }
    };

    // --- 初期化（既存データの読み込み） ---
    const saved = localStorage.getItem('allCountersSettings');
    if (saved) {
        try {
            const all = JSON.parse(saved);
            const me = all.find(x => x.id === MY_ID);
            if (me) apply(me);
        } catch(e) { console.error("Data load error", e); }
    }
})();
</script>
</body>
</html>